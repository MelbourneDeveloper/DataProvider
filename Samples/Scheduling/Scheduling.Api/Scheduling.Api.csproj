<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <NoWarn>CA1515;CA2100;RS1035;CA1508;CA2234;CA1812</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Data.Sqlite" Version="9.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Sync\Sync.SQLite\Sync.SQLite.csproj" />
    <ProjectReference Include="..\..\..\DataProvider\DataProvider\DataProvider.csproj" />
    <ProjectReference Include="..\..\..\Other\Selecta\Selecta.csproj" />
    <ProjectReference Include="..\..\..\Migration\Migration\Migration.csproj" />
    <ProjectReference Include="..\..\..\Migration\Migration.SQLite\Migration.SQLite.csproj" />
    <ProjectReference Include="..\..\Shared\Authorization\Authorization.csproj" />
  </ItemGroup>

  <ItemGroup>
    <AdditionalFiles Include="Queries/*.sql" />
    <AdditionalFiles Include="DataProvider.json" />
  </ItemGroup>

  <!-- Create database with schema before code generation (needed after git clean) -->
  <Target Name="CreateDatabaseSchema" BeforeTargets="GenerateDataProvider">
    <Exec Command='sqlite3 "$(MSBuildProjectDirectory)/scheduling-build.db" "CREATE TABLE IF NOT EXISTS fhir_Practitioner (Id TEXT PRIMARY KEY, Identifier TEXT NOT NULL, Active INTEGER NOT NULL DEFAULT 1, NameFamily TEXT NOT NULL, NameGiven TEXT NOT NULL, Qualification TEXT, Specialty TEXT, TelecomEmail TEXT, TelecomPhone TEXT); CREATE TABLE IF NOT EXISTS fhir_Schedule (Id TEXT PRIMARY KEY, Active INTEGER NOT NULL DEFAULT 1, PractitionerReference TEXT NOT NULL, PlanningHorizon INTEGER NOT NULL DEFAULT 30, Comment TEXT); CREATE TABLE IF NOT EXISTS fhir_Slot (Id TEXT PRIMARY KEY, ScheduleReference TEXT NOT NULL, Status TEXT NOT NULL, StartTime TEXT NOT NULL, EndTime TEXT NOT NULL, Overbooked INTEGER NOT NULL DEFAULT 0, Comment TEXT); CREATE TABLE IF NOT EXISTS fhir_Appointment (Id TEXT PRIMARY KEY, Status TEXT NOT NULL, ServiceCategory TEXT, ServiceType TEXT, ReasonCode TEXT, Priority TEXT NOT NULL, Description TEXT, StartTime TEXT NOT NULL, EndTime TEXT NOT NULL, MinutesDuration INTEGER NOT NULL, PatientReference TEXT NOT NULL, PractitionerReference TEXT NOT NULL, Created TEXT NOT NULL, Comment TEXT);"' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' />
  </Target>

  <!-- Generate C# from SQL using DataProvider.SQLite.Cli -->
  <Target Name="GenerateDataProvider" BeforeTargets="BeforeCompile;CoreCompile" Inputs="$(MSBuildProjectDirectory)/DataProvider.json;@(AdditionalFiles)" Outputs="$(MSBuildProjectDirectory)/Generated/.timestamp">
    <RemoveDir Directories="$(MSBuildProjectDirectory)/Generated" />
    <MakeDir Directories="$(MSBuildProjectDirectory)/Generated" />
    <Exec Command='dotnet run --project $(MSBuildThisFileDirectory)..\..\..\DataProvider\DataProvider.SQLite.Cli\DataProvider.SQLite.Cli.csproj -- --project-dir "$(MSBuildProjectDirectory)" --config "$(MSBuildProjectDirectory)/DataProvider.json" --out "$(MSBuildProjectDirectory)/Generated"' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' IgnoreExitCode='true' />
    <Touch Files="$(MSBuildProjectDirectory)/Generated/.timestamp" AlwaysCreate="true" />
  </Target>

</Project>
