<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <NoWarn>CA1515;CA2100;RS1035;CA1508;CA2234</NoWarn>
  </PropertyGroup>

  <!-- Exclude Generated folder from default globbing - we include it explicitly in the target -->
  <ItemGroup>
    <Compile Remove="Generated/**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Data.Sqlite" Version="9.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Sync\Sync.SQLite\Sync.SQLite.csproj" />
    <ProjectReference Include="..\..\..\DataProvider\DataProvider\DataProvider.csproj" />
    <ProjectReference Include="..\..\..\Other\Selecta\Selecta.csproj" />
    <ProjectReference Include="..\..\..\Migration\Migration\Migration.csproj" />
    <ProjectReference Include="..\..\..\Migration\Migration.SQLite\Migration.SQLite.csproj" />
    <ProjectReference Include="..\..\Shared\Authorization\Authorization.csproj" />
  </ItemGroup>

  <ItemGroup>
    <AdditionalFiles Include="Queries/*.sql" />
    <AdditionalFiles Include="DataProvider.json" />
  </ItemGroup>

  <!-- Create database with schema before code generation (needed after git clean) -->
  <Target Name="CreateDatabaseSchema" BeforeTargets="GenerateDataProvider">
    <Exec Command='sqlite3 "$(MSBuildProjectDirectory)/clinical-build.db" "CREATE TABLE IF NOT EXISTS fhir_Patient (Id TEXT PRIMARY KEY, Active INTEGER NOT NULL DEFAULT 1, GivenName TEXT NOT NULL, FamilyName TEXT NOT NULL, BirthDate TEXT, Gender TEXT CHECK(Gender IN (&apos;male&apos;, &apos;female&apos;, &apos;other&apos;, &apos;unknown&apos;)), Phone TEXT, Email TEXT, AddressLine TEXT, City TEXT, State TEXT, PostalCode TEXT, Country TEXT, LastUpdated TEXT NOT NULL DEFAULT (datetime(&apos;now&apos;)), VersionId INTEGER NOT NULL DEFAULT 1); CREATE TABLE IF NOT EXISTS fhir_Encounter (Id TEXT PRIMARY KEY, Status TEXT NOT NULL, Class TEXT NOT NULL, PatientId TEXT NOT NULL, PractitionerId TEXT, ServiceType TEXT, ReasonCode TEXT, PeriodStart TEXT NOT NULL, PeriodEnd TEXT, Notes TEXT, LastUpdated TEXT NOT NULL DEFAULT (datetime(&apos;now&apos;)), VersionId INTEGER NOT NULL DEFAULT 1); CREATE TABLE IF NOT EXISTS fhir_Condition (Id TEXT PRIMARY KEY, ClinicalStatus TEXT NOT NULL, VerificationStatus TEXT, Category TEXT DEFAULT &apos;problem-list-item&apos;, Severity TEXT, CodeSystem TEXT NOT NULL DEFAULT &apos;http://hl7.org/fhir/sid/icd-10-cm&apos;, CodeValue TEXT NOT NULL, CodeDisplay TEXT NOT NULL, SubjectReference TEXT NOT NULL, EncounterReference TEXT, OnsetDateTime TEXT, RecordedDate TEXT NOT NULL DEFAULT (date(&apos;now&apos;)), RecorderReference TEXT, NoteText TEXT, LastUpdated TEXT NOT NULL DEFAULT (datetime(&apos;now&apos;)), VersionId INTEGER NOT NULL DEFAULT 1); CREATE TABLE IF NOT EXISTS fhir_MedicationRequest (Id TEXT PRIMARY KEY, Status TEXT NOT NULL, Intent TEXT NOT NULL, PatientId TEXT NOT NULL, PractitionerId TEXT NOT NULL, EncounterId TEXT, MedicationCode TEXT NOT NULL, MedicationDisplay TEXT NOT NULL, DosageInstruction TEXT, Quantity REAL, Unit TEXT, Refills INTEGER NOT NULL DEFAULT 0, AuthoredOn TEXT NOT NULL DEFAULT (datetime(&apos;now&apos;)), LastUpdated TEXT NOT NULL DEFAULT (datetime(&apos;now&apos;)), VersionId INTEGER NOT NULL DEFAULT 1);"' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' />
  </Target>

  <!-- Generate C# from SQL using DataProvider.SQLite.Cli -->
  <Target Name="GenerateDataProvider" BeforeTargets="BeforeCompile;CoreCompile" Inputs="$(MSBuildProjectDirectory)/DataProvider.json;@(AdditionalFiles)" Outputs="$(MSBuildProjectDirectory)/Generated/.timestamp">
    <RemoveDir Directories="$(MSBuildProjectDirectory)/Generated" />
    <MakeDir Directories="$(MSBuildProjectDirectory)/Generated" />
    <Exec Command='dotnet run --project $(MSBuildThisFileDirectory)..\..\..\DataProvider\DataProvider.SQLite.Cli\DataProvider.SQLite.Cli.csproj -- --project-dir "$(MSBuildProjectDirectory)" --config "$(MSBuildProjectDirectory)/DataProvider.json" --out "$(MSBuildProjectDirectory)/Generated"' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' IgnoreExitCode='true' />
    <Touch Files="$(MSBuildProjectDirectory)/Generated/.timestamp" AlwaysCreate="true" />
    <ItemGroup>
      <Compile Include="$(MSBuildProjectDirectory)/Generated/**/*.g.cs" />
    </ItemGroup>
  </Target>

</Project>
