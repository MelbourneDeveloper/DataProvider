<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <TargetFramework>net9.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <GenerateDocumentationFile>false</GenerateDocumentationFile>
        <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference Include="../../DataProvider/DataProvider/DataProvider.csproj" />
        <ProjectReference Include="../../Other/Selecta/Selecta.csproj" />
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="Microsoft.Data.Sqlite" Version="9.0.0" />
    </ItemGroup>

    <ItemGroup>
        <AdditionalFiles Include="DataProvider.json" />
    </ItemGroup>

    <!-- YAML schema is source of truth -->
    <ItemGroup>
        <Content Include="../Lql.TypeProvider.FSharp.Tests/typeprovider-test-schema.yaml">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            <Link>typeprovider-test-schema.yaml</Link>
        </Content>
    </ItemGroup>

    <!-- Generated files are committed to git - SDK default globbing includes them -->
    <!-- These targets regenerate them when schema changes (incremental build) -->

    <!-- Create database from YAML using Migration.Cli -->
    <Target Name="CreateDatabaseSchema" BeforeTargets="GenerateDataProvider"
            Inputs="../Lql.TypeProvider.FSharp.Tests/typeprovider-test-schema.yaml"
            Outputs="../Lql.TypeProvider.FSharp.Tests/typeprovider-test.db">
        <Exec Command='dotnet run --project "$(MSBuildThisFileDirectory)../../Migration/Migration.Cli/Migration.Cli.csproj" -- --schema "$(MSBuildThisFileDirectory)../Lql.TypeProvider.FSharp.Tests/typeprovider-test-schema.yaml" --output "$(MSBuildThisFileDirectory)../Lql.TypeProvider.FSharp.Tests/typeprovider-test.db" --provider sqlite' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' />
    </Target>

    <!-- Generate C# extensions from schema using DataProvider.SQLite.Cli -->
    <Target Name="GenerateDataProvider" BeforeTargets="BeforeCompile;CoreCompile"
            Inputs="$(MSBuildProjectDirectory)/DataProvider.json;../Lql.TypeProvider.FSharp.Tests/typeprovider-test-schema.yaml"
            Outputs="$(MSBuildProjectDirectory)/Generated/.timestamp">
        <RemoveDir Directories="$(MSBuildProjectDirectory)/Generated" />
        <MakeDir Directories="$(MSBuildProjectDirectory)/Generated" />
        <Exec Command='dotnet run --project $(MSBuildThisFileDirectory)../../DataProvider/DataProvider.SQLite.Cli/DataProvider.SQLite.Cli.csproj -- --project-dir "$(MSBuildProjectDirectory)" --config "$(MSBuildProjectDirectory)/DataProvider.json" --out "$(MSBuildProjectDirectory)/Generated"' WorkingDirectory='$(MSBuildProjectDirectory)' StandardOutputImportance='High' StandardErrorImportance='High' />
        <Touch Files="$(MSBuildProjectDirectory)/Generated/.timestamp" AlwaysCreate="true" />
    </Target>
</Project>
