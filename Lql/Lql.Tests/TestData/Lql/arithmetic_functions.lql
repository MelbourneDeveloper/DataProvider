sales_data
|> select(
    sales_data.product_id,
    count(*) as total_sales,
    sum(sales_data.amount) as total_revenue,
    avg(sales_data.amount) as avg_sale,
    max(sales_data.amount) as max_sale,
    min(sales_data.amount) as min_sale,
    sum(sales_data.amount * sales_data.quantity) as weighted_revenue,
    round(avg(sales_data.amount), 2) as rounded_avg,
    abs(sum(sales_data.amount) - avg(sales_data.amount)) as deviation
)
|> group_by(sales_data.product_id)
|> having(fn(group) => count(*) > 5 and sum(sales_data.amount) > 1000) 